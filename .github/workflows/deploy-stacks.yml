name: deploy-stacks.yml
on:
  push:
    branches:
      - workflows

jobs:
  create-env-change-sets-and-deploy:
    permissions:
      id-token: write
      contents: read
      issues: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node and install cdk cli
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies and build project
        run: |
          npm install
          npm install -g aws-cdk
          #npm run build

      - name: Set up Env variables
        run: |
          echo "BETA_ACCOUNT_ID=${{ secrets.BETA_ACCOUNT_ID }}" >> $GITHUB_ENV
          # echo "PROD_ACCOUNT_ID=${{ secrets.PROD_ACCOUNT_ID }}" >> $GITHUB_ENV
          # echo "ASSUMED_ROLES=${{ secrets.ASSUMED_ROLES }}" >> $GITHUB_ENV
          echo "REGION=${{ secrets.REGION }}" >> $GITHUB_ENV

      - name: Configure beta deployment credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_DEPLOYMENT_ROLE }}
          aws-region: ${{ secrets.REGION }}

      - name: Create beta change-set for approval
        id: beta_stack_diff
        run: |
          DIFF_OUTPUT=$(cdk diff -c stage=Beta | sed -E 's/[0-9]{12}/[MASKED]/g')
          # Use GitHub's multiline output syntax
          echo "diff_output<<EOF" >> $GITHUB_OUTPUT
          echo "## CI-Config Stack Changeset" >> $GITHUB_OUTPUT
          echo "$DIFF_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Approve beta change set
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: 'rishabh6788'
          minimum-approvals: 1
          issue-title: 'Request to approve/deny Beta CI Stack Deployment'
          issue-body: |
            <details>
            <summary>Beta Stack Changeset Details</summary>

            ```
            ${{ steps.beta_stack_diff.outputs.diff_output }}
            ```
            </details>

